services:
  gradvy-postgres:
    image: postgres:15-alpine
    container_name: gradvy-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-gradvy_db}
      POSTGRES_USER: ${POSTGRES_USER:-gradvy_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-gradvy_secure_2024}
      POSTGRES_INITDB_ARGS: '--encoding=UTF-8 --lc-collate=C --lc-ctype=C'
    ports:
      - '${POSTGRES_PORT:-5433}:${POSTGRES_INTERNAL_PORT:-5432}'
    volumes:
      - gradvy_postgres:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U gradvy_user -d gradvy_db']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - gradvy-net
    restart: unless-stopped
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  gradvy-redis:
    image: redis:7-alpine
    container_name: gradvy-redis
    ports:
      - '${REDIS_PORT:-6380}:${REDIS_INTERNAL_PORT:-6379}'
    volumes:
      - gradvy_redis:/data
    command: redis-server --appendonly yes --appendfsync everysec --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - gradvy-net
    restart: unless-stopped
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  gradvy-mongodb:
    image: mongo:7.0
    container_name: gradvy-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-gradvy_admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-gradvy_mongo_secure_2024}
      MONGO_INITDB_DATABASE: ${MONGO_DB:-gradvy_preferences}
    ports:
      - '${MONGO_PORT:-27017}:${MONGO_INTERNAL_PORT:-27017}'
    volumes:
      - gradvy_mongodb:/data/db
      - gradvy_mongodb_config:/data/configdb
      - ./scripts/mongodb-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', 'db.adminCommand("ping")']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - gradvy-net
    restart: unless-stopped
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

volumes:
  gradvy_postgres:
    driver: local
    name: gradvy_postgres_data
  gradvy_redis:
    driver: local
    name: gradvy_redis_data
  gradvy_mongodb:
    driver: local
    name: gradvy_mongodb_data
  gradvy_mongodb_config:
    driver: local
    name: gradvy_mongodb_config_data

networks:
  gradvy-net:
    driver: bridge
    name: gradvy-network
